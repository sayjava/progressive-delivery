apiVersion: argoproj.io/v1alpha1 
kind: Rollout
metadata:
  name: canary-app
spec:
  replicas: 5
  selector:
    matchLabels:
      app: canary-app
  workloadRef:  # Reference an existing Deployment using workloadRef field
    apiVersion: apps/v1
    kind: Deployment
    name: canary-app
  revisionHistoryLimit: 0
  strategy:
    canary:
      abortScaleDownDelaySeconds: 600
      dynamicStableScale: true
      canaryService: canary-preview
      stableService: canary-prod
      trafficRouting:
        nginx:
          stableIngress: canary-prod
          additionalIngressAnnotations: # optional
            canary-by-header: X-Canary
            canary-by-header-value: commit-hash
      stableMetadata:
        labels:
          role: prod
      canaryMetadata:
        labels:
          role: preview

      steps:
        # 1 Pod Zero traffic
        - setCanaryScale:
            replicas: 1

        # Pause Indefinitely
        - pause: { }

        # 60% traffic
        - setCanaryScale:
            weight: 60
            matchTrafficWeight: true

        # Pause Indefinitely
        - pause: { }

        # Full release
        - setWeight: 100
        # 50% traffic
